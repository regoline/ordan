{% extends "authenticated_base2.html" %}

{% block content %}
<section class="w-full max-w-2xl mx-auto p-4 md:p-6">
    <!-- Header -->
    <div class="bg-gray-800/50 rounded-lg p-6 mb-6">
        <h2 class="text-2xl font-bold">Send Message</h2>
    </div>

    <!-- Message Form -->
    <form method="POST" action="{{ url_for('game.send_message') }}" class="bg-gray-800/50 rounded-lg p-6">
        <input type="hidden" name="recipient_id" value="{{ recipient.id if recipient else '' }}">
        <input type="hidden" name="parent_message_id" value="{{ parent_message.id if parent_message else '' }}">
        
        <!-- Recipient Field -->
        <div class="mb-6">
            <label for="recipient" class="block text-gray-300 mb-2 font-medium">To:</label>
            {% if recipient %}
                <input type="text" id="recipient" value="{{ recipient.name }}" 
                       class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" readonly>
            {% else %}
                <select name="recipient_id" id="recipient" required
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                    <option value="">Select recipient...</option>
                    {% for char in Character.query.order_by(Character.name).all() %}
                        {% if char.id != current_user.character.id %}
                        <option value="{{ char.id }}">{{ char.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            {% endif %}
        </div>
        
        <!-- Subject Field -->
        <div class="mb-6">
            <label for="subject" class="block text-gray-300 mb-2 font-medium">Subject:</label>
            <input type="text" id="subject" name="subject" 
                   value="{{ subject_prefix if subject_prefix else '' }}" required
                   class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
        </div>
        
        <!-- Message Body -->
        <div class="mb-6">
            <label for="body" class="block text-gray-300 mb-2 font-medium">Message:</label>
            <textarea id="body" name="body" rows="10" required
                      class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white min-h-[200px]"></textarea>
        </div>
        
        <!-- Original Message Preview -->
        {% if parent_message %}
        <div class="mb-6 bg-gray-700/50 rounded-lg p-4 border border-gray-600">
            <h4 class="text-lg font-semibold mb-3 text-gray-300">Original Message</h4>
            <div class="text-sm text-gray-300 space-y-2">
                <p><strong class="text-gray-400">From:</strong> {{ parent_message.sender.name }}</p>
                <p><strong class="text-gray-400">Sent:</strong> {{ parent_message.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                <p><strong class="text-gray-400">Subject:</strong> {{ parent_message.subject }}</p>
                <div class="mt-3 p-3 bg-gray-800 rounded whitespace-pre-line">
                    {{ parent_message.body|safe }}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Form Actions -->
        <div class="flex gap-3">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                Send
            </button>
            <a href="{{ url_for('game.mailbox') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition-colors text-center">
                Cancel
            </a>
        </div>
    </form>
</section>
{% endblock %}
